{% extends 'ticket_system/base.html' %}

{% block title %}Create New Ticket - Ticket Management System{% endblock %}

{% block page_title %}Create New Ticket{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{% url 'ticket_list' %}">Tickets</a></li>
<li class="breadcrumb-item active">Create New Ticket</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="form-card">
            <div class="form-header">
                <i class="fas fa-plus-circle"></i>
                <h3>Create New Ticket</h3>
                <p class="text-muted">Please fill out the form to create a new support ticket</p>
            </div>
            
            <form method="post" enctype="multipart/form-data" novalidate>
                {% csrf_token %}
                
                <div class="mb-3">
                    <label for="id_title" class="form-label">Title</label>
                    <input type="text" name="title" id="id_title" class="form-control {% if form.title.errors %}is-invalid{% endif %}" placeholder="Brief description of the issue" value="{{ form.title.value|default:'' }}" required>
                    {% if form.title.errors %}
                    <div class="invalid-feedback">
                        {{ form.title.errors.0 }}
                    </div>
                    {% endif %}
                </div>
                
                <div class="mb-3">
                    <label for="id_description" class="form-label">Description</label>
                    <textarea name="description" id="id_description" rows="5" class="form-control {% if form.description.errors %}is-invalid{% endif %}" placeholder="Detailed description of the issue" required>{{ form.description.value|default:'' }}</textarea>
                    {% if form.description.errors %}
                    <div class="invalid-feedback">
                        {{ form.description.errors.0 }}
                    </div>
                    {% endif %}
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="id_department" class="form-label">Department</label>
                        <select name="department" id="id_department" class="form-select {% if form.department.errors %}is-invalid{% endif %}" required>
                            <option value="">Select Department</option>
                            {% for dept in form.department.field.queryset %}
                            <option value="{{ dept.id }}" {% if form.department.value|stringformat:"i" == dept.id|stringformat:"i" %}selected{% endif %}>
                                {{ dept.name }}
                            </option>
                            {% endfor %}
                        </select>
                        {% if form.department.errors %}
                        <div class="invalid-feedback">
                            {{ form.department.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6">
                        <label for="id_category" class="form-label">Category</label>
                        <select name="category" id="id_category" class="form-select {% if form.category.errors %}is-invalid{% endif %}" required>
                            <option value="">Select Category</option>
                            {% for cat in form.category.field.queryset %}
                            <option value="{{ cat.id }}" {% if form.category.value|stringformat:"i" == cat.id|stringformat:"i" %}selected{% endif %}>
                                {{ cat.name }}
                            </option>
                            {% endfor %}
                        </select>
                        {% if form.category.errors %}
                        <div class="invalid-feedback">
                            {{ form.category.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="id_priority" class="form-label">Priority</label>
                        <select name="priority" id="id_priority" class="form-select {% if form.priority.errors %}is-invalid{% endif %}" required>
                            <option value="">Select Priority</option>
                            {% for value, label in form.priority.field.choices %}
                            <option value="{{ value }}" {% if form.priority.value == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>
                        {% if form.priority.errors %}
                        <div class="invalid-feedback">
                            {{ form.priority.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6">
                        <label for="id_attachments" class="form-label">Attachments (Optional)</label>
                        <input type="file" name="attachments" id="id_attachments" class="form-control {% if form.attachments.errors %}is-invalid{% endif %}" multiple>
                        {% if form.attachments.errors %}
                        <div class="invalid-feedback">
                            {{ form.attachments.errors.0 }}
                        </div>
                        {% endif %}
                        <div class="form-text">
                            You can upload multiple files. Maximum file size: 10MB.
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="form-check">
                        <input type="checkbox" name="is_urgent" id="id_is_urgent" class="form-check-input {% if form.is_urgent.errors %}is-invalid{% endif %}" {% if form.is_urgent.value %}checked{% endif %}>
                        <label for="id_is_urgent" class="form-check-label">Mark as Urgent</label>
                        {% if form.is_urgent.errors %}
                        <div class="invalid-feedback">
                            {{ form.is_urgent.errors.0 }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="ai-analysis-section mb-4">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="fas fa-robot me-2"></i>AI Suggestions (updates as you type)</h5>
                        </div>
                        <div class="card-body">
                            <div id="ai-suggestions-placeholder">
                                <p class="text-muted">AI will analyze your title and description to suggest appropriate fields.</p>
                            </div>
                            <div id="ai-suggestions" class="d-none">
                                <div class="mb-2">
                                    <strong>Suggested Department:</strong>
                                    <span id="suggested-department" class="badge bg-info ms-1"></span>
                                </div>
                                <div class="mb-2">
                                    <strong>Suggested Category:</strong>
                                    <span id="suggested-category" class="badge bg-info ms-1"></span>
                                </div>
                                <div>
                                    <strong>Suggested Priority:</strong>
                                    <span id="suggested-priority" class="badge bg-info ms-1"></span>
                                </div>
                            </div>
                            <div id="ai-loading" class="d-none text-center">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span class="ms-1">Analyzing...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2"></i>Submit Ticket
                    </button>
                    <a href="{% url 'ticket_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                </div>
                
                {% if form.non_field_errors %}
                <div class="alert alert-danger mt-3">
                    {% for error in form.non_field_errors %}
                    {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </form>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // JavaScript for dynamic form handling
    document.addEventListener('DOMContentLoaded', function() {
        // Department and Category relationship
        const departmentSelect = document.getElementById('id_department');
        const categorySelect = document.getElementById('id_category');
        const titleField = document.getElementById('id_title');
        const descriptionField = document.getElementById('id_description');
        const prioritySelect = document.getElementById('id_priority');
        let debounceTimer;
        
        // Handle department change
        departmentSelect.addEventListener('change', function() {
            const departmentId = this.value;
            if (departmentId) {
                fetch(`/ajax/get-categories/?department=${departmentId}`)
                    .then(response => response.json())
                    .then(data => {
                        // Clear current options
                        categorySelect.innerHTML = '<option value="">Select Category</option>';
                        
                        // Add new options
                        data.categories.forEach(category => {
                            const option = document.createElement('option');
                            option.value = category.id;
                            option.textContent = category.name;
                            categorySelect.appendChild(option);
                        });
                        
                        // Enable category select
                        categorySelect.disabled = false;
                    })
                    .catch(error => console.error('Error fetching categories:', error));
            } else {
                // Reset and disable category select if no department selected
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                categorySelect.disabled = true;
            }
        });
        
        // Function to get CSRF token from cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // AI Suggestions based on title and description
        function fetchSuggestions() {
            const title = titleField.value;
            const description = descriptionField.value;

            if (title.length < 5 && description.length < 20) {
                document.getElementById('ai-suggestions-placeholder').classList.remove('d-none');
                document.getElementById('ai-suggestions').classList.add('d-none');
                document.getElementById('ai-loading').classList.add('d-none');
                return; // Not enough text yet
            }

            document.getElementById('ai-suggestions-placeholder').classList.add('d-none');
            document.getElementById('ai-suggestions').classList.add('d-none'); // Hide old suggestions
            document.getElementById('ai-loading').classList.remove('d-none'); // Show loading

            fetch("{% url 'api:suggest_ticket_fields' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                credentials: 'include', // Ensure cookies (including sessionid) are sent
                body: JSON.stringify({ title: title, description: description })
            })
            .then(response => {
                if (!response.ok) {
                    console.error(`API Error: ${response.status} ${response.statusText}`);
                    if (response.status === 403) {
                        console.error("Received 403 Forbidden. Check CSRF token and authentication.");
                    }
                    throw new Error(`API Error: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('ai-loading').classList.add('d-none');
                document.getElementById('ai-suggestions').classList.remove('d-none');

                // Update suggestion badges
                if (data.suggested_department_name) {
                    document.getElementById('suggested-department').textContent = data.suggested_department_name;
                } else {
                    document.getElementById('suggested-department').textContent = 'N/A';
                }
                
                if (data.suggested_category_name) {
                    document.getElementById('suggested-category').textContent = data.suggested_category_name;
                } else {
                    document.getElementById('suggested-category').textContent = 'N/A';
                }
                
                if (data.suggested_priority) {
                    document.getElementById('suggested-priority').textContent = 
                        data.suggested_priority.charAt(0).toUpperCase() + 
                        data.suggested_priority.slice(1);
                } else {
                    document.getElementById('suggested-priority').textContent = 'N/A';
                }

                // Optional: Auto-select dropdown values
                // Only select if the user hasn't made a choice yet
                if (data.suggested_department_id && !departmentSelect.value) {
                    departmentSelect.value = data.suggested_department_id;
                    // Trigger change event to load categories
                    departmentSelect.dispatchEvent(new Event('change'));
                    // Need a small delay for categories to load before selecting category
                    setTimeout(() => {
                        if (data.suggested_category_id && !categorySelect.value && 
                            categorySelect.querySelector(`option[value="${data.suggested_category_id}"]`)) {
                            categorySelect.value = data.suggested_category_id;
                        }
                    }, 500); // Adjust delay as needed
                }
                
                if (data.suggested_priority && !prioritySelect.value) {
                    const prioOption = Array.from(prioritySelect.options).find(
                        opt => opt.value === data.suggested_priority
                    );
                    if (prioOption) {
                        prioritySelect.value = data.suggested_priority;
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching AI suggestions:', error);
                document.getElementById('ai-loading').classList.add('d-none');
                document.getElementById('ai-suggestions-placeholder').classList.remove('d-none');
                document.getElementById('ai-suggestions-placeholder').innerHTML = '<p class="text-danger">Error fetching suggestions.</p>';
            });
        }

        // Add event listeners with debouncing
        [titleField, descriptionField].forEach(field => {
            field.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(fetchSuggestions, 1000); // Fetch after 1 sec of inactivity
            });
        });
    });
</script>
{% endblock %}
{% endblock %}
